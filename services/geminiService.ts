
import { GoogleGenAI, Chat } from "@google/genai";

const STUDENT_DATA_CONTEXT = `
--- OCR Data Page 1 (Student List) ---
1446-1447: العام الدراسي
النظام الدراسي: الكل
الصف: الأول المتوسط
القسم: تعليم عام مطبق تدريس لغة صينية
الفصل: 1
اسم الطالب: أمير توفیق ابراهيم شحار (AMEER TOFIG IBRAHIM SHAHAR), الجنسية: السعودية, رقم الهوية: 1165752286, تاريخ الميلاد: 02/09/1433, تاريخ الإلتحاق: 01/01/1438
اسم الطالب: أيهم باسم علي رضوان (AYHAM BASIM ALI RADWAN), الجنسية: السعودية, رقم الهوية: 1169602750, تاريخ الميلاد: 09/02/1434, تاريخ الإلتحاق: 04/01/1441
اسم الطالب: احمد جابر علي العزي (AHMED JABER ALI ALIZZI), الجنسية: السعودية, رقم الهوية: 1154792657, تاريخ الميلاد: 09/05/1432, تاريخ الإلتحاق: 22/11/1440
اسم الطالب: احمد علي حسن بعيطي, الجنسية: السعودية, رقم الهوية: 1166990174, تاريخ الميلاد: 09/02/1435, تاريخ الإلتحاق: 21/01/1446
اسم الطالب: الواليد سامي احمد جعفر (WSAJ), الجنسية: السعودية, رقم الهوية: 1164791632, تاريخ الميلاد: 07/09/1434, تاريخ الإلتحاق: 04/05/1439
اسم الطالب: باسل سالم علي صهلولي (BASIL SALEM ALI SUHLULI), الجنسية: السعودية, رقم الهوية: 1166962900, تاريخ الميلاد: 13/12/1434, تاريخ الإلتحاق: 20/12/1439
اسم الطالب: تركي عبدالله هاشم موسي (TURKI ABDULLAH HASHIM MOUSA), الجنسية: السعودية, رقم الهوية: 1168704201, تاريخ الميلاد: 09/07/1435, تاريخ الإلتحاق: 18/02/1445
اسم الطالب: حسن علي حسن عائش (HASSAN ALI HASSAN AAYISH), الجنسية: السعودية, رقم الهوية: 1164443143, تاريخ الميلاد: 02/08/1434, تاريخ الإلتحاق: 29/12/1439
اسم الطالب: حسین خالد مهدي حبيب (HKMH), الجنسية: السعودية, رقم الهوية: 1165180405, تاريخ الميلاد: 01/10/1434, تاريخ الإلتحاق: 07/05/1440
اسم الطالب: خالد محمد يحي المالكي (KHALID MOHAMMED YAHYA ALMALKI), الجنسية: السعودية, رقم الهوية: 1163970534, تاريخ الميلاد: 01/05/1434, تاريخ الإلتحاق: 22/11/1440

--- OCR Data Page 2 (Student List) ---
اسم الطالب: خالد موفق عبد العزيز عشري (KHALID MUWAFFAQ ABDULAZIZ ASHRI), الجنسية: السعودية, رقم الهوية: 1164043588, تاريخ الميلاد: 20/05/1434, تاريخ الإلتحاق: 06/01/1440
اسم الطالب: رائف مهنا محمد شيعاني (RMMS), الجنسية: السعودية, رقم الهوية: 1167548849, تاريخ الميلاد: 18/04/1435
اسم الطالب: راشد عبدالرحمن مفرح الفيفي (RASHED ABDULRAHMAN MOFAREH ALFAIFI), الجنسية: السعودية, رقم الهوية: 1162046385, تاريخ الميلاد: 28/11/1433, تاريخ الإلتحاق: 22/11/1440
اسم الطالب: راكان حسن حسين حفظي (RAKAN HASSAN HUSSAIN HIFTHI), الجنسية: السعودية, رقم الهوية: 1164914580, تاريخ الميلاد: 11/07/1434, تاريخ الإلتحاق: 22/11/1440
اسم الطالب: رواد عثمان علي شاجري (RUWWAD OTHMAN ALI SHAJIRI), الجنسية: السعودية, رقم الهوية: 1166492429, تاريخ الميلاد: 28/01/1435, تاريخ الإلتحاق: 22/11/1440
اسم الطالب: رياض بن احمد بن حسن بن عيسى زين الدين (RIYADH AHMED HASSAN ZAIN ALDEEN), الجنسية: السعودية, رقم الهوية: 1171545682, تاريخ الميلاد: 28/07/1434, تاريخ الإلتحاق: 22/11/1440
اسم الطالب: سالم علي عائل حريصي (SALM -- HARISI), الجنسية: السعودية, رقم الهوية: 1156769513, تاريخ الميلاد: 27/10/1432, تاريخ الإلتحاق: 01/01/1441
اسم الطالب: سعود عبدالله محمد الحربي (SAUD ABDULLAH MOHAMMED ALHARBI), الجنسية: السعودية, رقم الهوية: 1169503503, تاريخ الميلاد: 09/10/1434, تاريخ الإلتحاق: 27/11/1440
اسم الطالب: سلطان عبده برشیش کاسب (SULTAN - - KASIB), الجنسية: السعودية, رقم الهوية: 1157996537, تاريخ الميلاد: 28/12/1432, تاريخ الإلتحاق: 28/11/1439, حالة القيد: راسب سنة
اسم الطالب: عبدالاله فؤاد احمد قاضي (ABDULELAH FUAD AHMED GADI), الجنسية: السعودية, رقم الهوية: 1163358185, تاريخ الميلاد: 29/03/1434, تاريخ الإلتحاق: 28/01/1440

--- OCR Data Page 3 (Student List) ---
اسم الطالب: عبدالرحمن الحسن ابراهيم مسلم (ABD ALRAHAMAN ALHASAN IBRAHIM MSLM), الجنسية: السعودية, رقم الهوية: 1166736445, تاريخ الميلاد: 15/02/1435
اسم الطالب: عبدالرحمن سعود عبده دغريري (ABDULRAHMAN SAUD ABDU DAGHREERI), الجنسية: السعودية, رقم الهوية: 1166393577, تاريخ الميلاد: 26/12/1434
اسم الطالب: عبدالعزيز عادل ابراهیم ثابت (AAIIT), الجنسية: السعودية, رقم الهوية: 1164661389, تاريخ الميلاد: 25/08/1434, تاريخ الإلتحاق: 26/12/1438
اسم الطالب: علي بن عبدالقادر بن هادي آل هديش (ALI ABDALKADER HADI ALHEDAISH), الجنسية: السعودية, رقم الهوية: 1164625889, تاريخ الميلاد: 04/04/1434, تاريخ الإلتحاق: 22/11/1440
اسم الطالب: عماد علي عبدالله عواجي (AAAA), الجنسية: السعودية, رقم الهوية: 1163564634, تاريخ الميلاد: 21/05/1434
اسم الطالب: عمار موسي احمد خرمي (AMAZ), الجنسية: السعودية, رقم الهوية: 1167277415, تاريخ الميلاد: 06/01/1435, تاريخ الإلتحاق: 22/11/1440
اسم الطالب: فارس عبدالرحمن يحي الظلمي (FARIS ABDU YAHYA ALTHULMI), الجنسية: السعودية, رقم الهوية: 1164776955, تاريخ الميلاد: 08/09/1434, تاريخ الإلتحاق: 22/11/1440
اسم الطالب: مؤيد عيسى اسعد الفيفي (MEA ALF), الجنسية: السعودية, رقم الهوية: 1165947274, تاريخ الميلاد: 07/12/1434, تاريخ الإلتحاق: 26/12/1439
اسم الطالب: محمد ابراهيم محمد صعابي (MOHAMMED IBRAHIM MOHAMMED SAABI), الجنسية: السعودية, رقم الهوية: 1166194272, تاريخ الميلاد: 07/01/1435, تاريخ الإلتحاق: 16/12/1439
اسم الطالب: وسام بن حمد بن محمد بن حسين حكمي (WHMH), الجنسية: السعودية, رقم الهوية: 1164687707, تاريخ الميلاد: 02/09/1434

--- OCR Data Page 4 (Student List) ---
اسم الطالب: وسام سامي علي عمر (WSAO), الجنسية: السعودية, رقم الهوية: 1163022617, تاريخ الميلاد: 16/04/1434
اسم الطالب: وسام عبدالرحمن علي الفيفي (WESAM ABDALRAHMAN ALI ALFAIFI), الجنسية: السعودية, رقم الهوية: 1166475101, تاريخ الميلاد: 14/01/1435

--- OCR Data Page 5 (Grades) ---
المادة: المهارات رقمية.
اسم الطالب: احمد جابر علي العزي, رقم الجلوس: 01300001, المجموع: 40
اسم الطالب: احمد علي حسن بعيطي, رقم الجلوس: 01300002, المجموع: 42
اسم الطالب: الواليد سامي احمد جعفر, رقم الجلوس: 01300008, المجموع: 46
اسم الطالب: أمير توفیق ابراهيم شحار, رقم الجلوس: 01300015, المجموع: 45.5
اسم الطالب: ایاد حسن محمود نصار, المجموع: 37.5
اسم الطالب: أيهم باسم علي رضوان, رقم الجلوس: 01300016, المجموع: 47
اسم الطالب: باسل سالم علي صهلولي, رقم الجلوس: 01300018, المجموع: 47
اسم الطالب: تركي عبدالله هاشم موسي, رقم الجلوس: 01300020, المجموع: 32.5
اسم الطالب: حسن علي حسن عائش, رقم الجلوس: 01300023, المجموع: 35
اسم الطالب: حسین خالد مهدي حبيب, رقم الجلوس: 01300032, المجموع: 42.5
اسم الطالب: خالد محمد يحي المالكي, رقم الجلوس: 01300027, المجموع: 46.5
اسم الطالب: خالد موفق عبدالعزيز عشري, رقم الجلوس: 01300028, المجموع: 47
اسم الطالب: راشد عبد الرحمن مفرح الفيفي, رقم الجلوس: 01300031, المجموع: 47
اسم الطالب: راكان حسن حسين حفظي, رقم الجلوس: 01300033, المجموع: 41
اسم الطالب: رائف مهنا محمد شيعاني, رقم الجلوس: 01300030, المجموع: 35
اسم الطالب: رواد عثمان علي شاجري, رقم الجلوس: 01300035, المجموع: 46
اسم الطالب: رياض بن احمد بن حسن بن عيسى زين الدين, رقم الجلوس: 01300010, المجموع: 37.5
اسم الطالب: سالم علي عائل حريصي, رقم الجلوس: 01300041, المجموع: 41
اسم الطالب: سعود عبدالله محمد الحربي, رقم الجلوس: 01300031, المجموع: 35
اسم الطالب: سلطان عبده برشیش کاسب, المجموع: 35
اسم الطالب: سلمان محمد زيد الرصاص, المجموع: 46
اسم الطالب: عبدالاله فؤاد احمد قاضي, رقم الجلوس: 01300046, المجموع: 39.5
اسم الطالب: عبدالرحمن الحسن ابراهيم مسلم, رقم الجلوس: 01300048, المجموع: 43
اسم الطالب: عبدالرحمن سعود عبده دغريري, رقم الجلوس: 01300049, المجموع: 45
اسم الطالب: عبدالعزيز عادل ابراهیم ثابت, رقم الجلوس: 01300146, المجموع: 50
اسم الطالب: عبداللطيف عبدالله حيدر علي, المجموع: 43.5
اسم الطالب: علي بن عبدالقادر بن هادي آل هديش, رقم الجلوس: 01300060, المجموع: 35
اسم الطالب: عماد علي عبدالله عواجي, رقم الجلوس: 01300064, المجموع: 44
اسم الطالب: عمار موسي احمد خرمي, رقم الجلوس: 01300065, المجموع: 41.5
اسم الطالب: عمر أحمد الحسن, رقم الجلوس: 01300066, المجموع: 40.5

--- OCR Data Page 6 (Grades) ---
اسم الطالب: فارس عبدالرحمن يحي الظلمي, رقم الجلوس: 01300252, المجموع: 40
اسم الطالب: محمد ابراهيم محمد صعابي, رقم الجلوس: 01300078, المجموع: 48
اسم الطالب: محمد هاشم مصطفى, المجموع: 43
اسم الطالب: مؤيد عيسى اسعد الفيفي, رقم الجلوس: 01300074, المجموع: 42
اسم الطالب: وسام بن حمد بن محمد بن حسين حكمي, رقم الجلوس: 01300092, المجموع: 37.5
اسم الطالب: وسام سامي علي عمر, رقم الجلوس: 01300094, المجموع: 46.5
اسم الطالب: وسام عبدالرحمن علي الفيفي, رقم الجلوس: 01300095, المجموع: 40.5
`;

const SYSTEM_INSTRUCTION = `أنت مساعد متخصص في الإجابة على الأسئلة المتعلقة ببيانات الطلاب فقط. يجب أن تستخدم المعلومات المقدمة لك في السياق التالي بشكل حصري. لا تستخدم أي معرفة خارجية. إذا كان السؤال لا يمكن الإجابة عليه من البيانات المتوفرة، قل بلطف "المعلومات المطلوبة غير متوفرة في السجلات". يجب أن تكون جميع إجاباتك باللغة العربية.

إليك بيانات الطلاب:
---
${STUDENT_DATA_CONTEXT}
---
`;

let chat: Chat | null = null;

const getChat = (): Chat => {
    if (!chat) {
        if (!process.env.API_KEY) {
            throw new Error("API_KEY environment variable is not set.");
        }
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
        chat = ai.chats.create({
            model: 'gemini-2.5-flash',
            config: {
                systemInstruction: SYSTEM_INSTRUCTION,
            }
        });
    }
    return chat;
}

export const getChatResponse = async (message: string): Promise<string> => {
  try {
    const chatSession = getChat();
    const result = await chatSession.sendMessage({ message });
    return result.text;
  } catch (error) {
    console.error("Error getting chat response:", error);
    return "عفواً، حدث خطأ أثناء معالجة طلبك.";
  }
};
